name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events
  push:
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs a single command using the runner's shell
      - name: Run a one-line script
        run: echo Hello, world!

      # Runs a set of commands using the runner's shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.

  # Static code style check using ktlint + PR annotations via reviewdog
  lint:
    name: Ktlint (code style)
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout
        uses: actions/checkout@v4

      # Installs Java 21 (Temurin distribution â€” OpenJDK by Eclipse Adoptium) so Gradle and ktlint can run
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # Validates the Gradle Wrapper for security (prevents running a compromised wrapper)
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      # Sets up Gradle with dependency caching to speed up subsequent runs
      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      # Runs ktlint across the project, printing violations to the log and generating Checkstyle XML reports
      - name: Run ktlint (generate checkstyle)
        run: ./gradlew ktlintCheck --console=plain

      # Uploads the ktlint XML report(s) as an artifact for later download/debugging (optional)
      - name: Upload ktlint report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-report
          path: "**/build/reports/ktlint/**/*.xml"

      # Annotates pull requests with inline comments based on the ktlint Checkstyle reports (only runs on PRs)
      - name: Reviewdog (annotate PR)
        if: ${{ github.event_name == 'pull_request' }}
        uses: reviewdog/action-checkstyle@v1
        with:
          reporter: github-pr-review      # Leaves inline PR review comments on changed lines
          filter_mode: diff_context       # Only comment on the diff (not on untouched files/lines)
          level: error                    # Mark findings as 'error' severity
          path: .                         # Repository root
          checkstyle_reporter_input: "**/build/reports/ktlint/**/*.xml"
