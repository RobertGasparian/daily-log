name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events
  push:
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs a single command using the runner's shell
      - name: Run a one-line script
        run: echo Hello, world!

      # Runs a set of commands using the runner's shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.

  # Static code style check using ktlint + PR annotations via reviewdog
  lint:
    name: Ktlint (code style)
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout
        uses: actions/checkout@v4

      # Installs Java 21 (Temurin distribution — OpenJDK by Eclipse Adoptium) so Gradle and ktlint can run
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # Validates the Gradle Wrapper for security (prevents running a compromised wrapper)
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      # Sets up Gradle with dependency caching to speed up subsequent runs
      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v3

      # Runs ktlint across the project, printing violations to the log and generating Checkstyle XML reports
      # IMPORTANT: continue-on-error so later steps (reviewdog) still run even if there are violations
      - name: Run ktlint (generate checkstyle)
        run: |
          ./gradlew ktlintCheck --console=plain || EXIT_CODE=$?
          # If ktlint failed, mark neutral exit (78) instead of success (0)
          if [ "${EXIT_CODE}" != "" ]; then
            echo "Ktlint found issues."
            exit 78  # Neutral — will show as ⚪ in the checks list
          fi
        continue-on-error: true  # allow job to continue when ktlint finds issues

      # Uploads the ktlint XML report(s) as an artifact for later download/debugging (optional)
      - name: Upload ktlint report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-report
          path: "**/build/reports/ktlint/**/*.xml"

      # Installs reviewdog CLI (used to convert ktlint's Checkstyle XML into inline PR comments)
      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b "$HOME/bin"
          echo "$HOME/bin" >> "$GITHUB_PATH"

      # Annotates pull requests with inline comments based on the ktlint Checkstyle reports.
      # Works for both pull_request runs and push runs that belong to an open PR.
      - name: Reviewdog (annotate PR)
        # If you only want comments on actual PR runs, you can simplify this to:
        # if: ${{ github.event_name == 'pull_request' }}
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
        env:
          # GitHub token needed for reviewdog to post comments (provided automatically by Actions)
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure we have ktlint Checkstyle reports
          if ! find . -type f -path "*/build/reports/ktlint/*/*.xml" | grep -q . ; then
            echo "No ktlint Checkstyle reports found. Did ktlintCheck run?"
            exit 0
          fi

          # Stream all XMLs into reviewdog without storing NUL-separated paths in a shell var.
          # - reporter=github-pr-review -> inline PR review comments
          # - filter-mode=diff_context  -> only comment on changed lines
          # - level=error               -> mark as error in the PR UI
          find . -type f -path "*/build/reports/ktlint/*/*.xml" -print0 \
            | xargs -0 -r cat \
            | reviewdog \
                -f=checkstyle \
                -name="ktlint" \
                -reporter=github-pr-review \
                -filter-mode=diff_context \
                -level=error

          # (Optional) If you want the job to FAIL when violations exist, uncomment below.
          # This avoids deprecated '-fail-on-error' and works with github-pr-review.
           if find . -type f -path "*/build/reports/ktlint/*/*.xml" -print0 \
                | xargs -0 -r grep -q "<error " ; then
             echo "ktlint violations found."
             exit 1
           fi
